#!/usr/bin/env node

const rlp = require('../dist/index.js')
const method = process.argv[2]
const strInput = process.argv[3]

if (typeof strInput !== 'string') {
  return console.error(`Expected JSON string input, received type: ${typeof strInput}`)
}

if (method === 'encode') {
  // Parse JSON
  let json
  try {
    json = JSON.parse(strInput)
  } catch (error) {
    return console.error(`Error could not parse JSON: ${JSON.stringify(error)}`)
  }

  // Encode RLP
  try {
    const encoded = rlp.encode(json)
    console.log('0x' + rlp.utils.bytesToHex(Uint8Array.from(encoded)))
  } catch (error) {
    console.error(`Error encoding RLP: ${JSON.stringify(error)}`)
  }
} else if (method === 'decode') {
  // Decode
  try {
    const decoded = rlp.decode(strInput)
    const json = JSON.stringify(baToJSON(decoded))
    console.log(json)
  } catch (error) {
    console.error(`Error decoding RLP: ${JSON.stringify(error)}`)
  }
} else {
  console.error('Unsupported method')
}

/**
 * Buffer or Buffer Array to JSON
 */
function baToJSON(ba) {
  if (ba instanceof Uint8Array) {
    return rlp.utils.bytesToHex(ba)
  } else if (ba instanceof Array) {
    const arr = []
    for (let i = 0; i < ba.length; i++) {
      arr.push(baToJSON(ba[i]))
    }
    return arr
  }
}
